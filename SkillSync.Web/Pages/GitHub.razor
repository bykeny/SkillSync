@page "/github"
@attribute [Authorize]
@using SkillSync.Web.Models
@using SkillSync.Web.Services
@inject IGitHubService GitHubService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>GitHub Integration - SkillSync</PageTitle>

<div class="px-4 sm:px-0">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">GitHub Integration</h1>
        <p class="text-gray-600 mt-1">Connect your GitHub account to track coding activity</p>
    </div>

    @if (isLoading)
    {
        <div class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
    }
    else if (connection?.IsConnected == true)
    {
        <!-- Connected State -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-green-100 rounded-full p-3">
                        <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-medium text-gray-900">Connected to GitHub</h3>
                        <p class="text-sm text-gray-500">@connection.GitHubUsername</p>
                        @if (connection.LastSyncedAt != null)
                        {
                            <p class="text-xs text-gray-400">Last synced: @connection.LastSyncedAt.Value.ToString("MMM dd, yyyy h:mm tt")</p>
                        }
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @onclick="SyncData" disabled="@isSyncing" class="btn-primary">
                        @if (isSyncing)
                        {
                            <span>Syncing...</span>
                        }
                        else
                        {
                            <span>Sync Now</span>
                        }
                    </button>
                    <button @onclick="Disconnect" class="btn-secondary text-red-600">
                        Disconnect
                    </button>
                </div>
            </div>
        </div>

        <!-- GitHub Stats -->
        @if (stats != null)
        {
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Repository Stats</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Repositories</span>
                            <span class="text-2xl font-bold text-gray-900">@stats.TotalRepositories</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Commits</span>
                            <span class="text-2xl font-bold text-gray-900">@stats.TotalCommits</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Language Breakdown</h3>
                    @if (stats.LanguageBreakdown.Any())
                    {
                        <div class="space-y-3">
                            @foreach (var lang in stats.LanguageBreakdown.OrderByDescending(l => l.Value).Take(5))
                            {
                                var percentage = (lang.Value * 100.0 / stats.LanguageBreakdown.Values.Sum());
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-gray-600">@lang.Key</span>
                                        <span class="text-gray-900 font-medium">@percentage.ToString("F1")%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full transition-all" 
                                             style="width: @percentage%"></div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-gray-500 text-sm">No language data available</p>
                    }
                </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex">
                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-blue-800">
                        <p class="font-medium">Auto-Skill Mapping Enabled</p>
                        <p class="mt-1">Programming languages detected in your repositories are automatically added to your skills!</p>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <!-- Not Connected State -->
        <div class="bg-white rounded-lg shadow p-8 text-center">
            <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Connect Your GitHub Account</h3>
            <p class="text-gray-600 mb-6">
            Automatically track your coding activity, repository stats, and programming languages.
            </p>
            <div class="space-y-3 text-left max-w-md mx-auto mb-6">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                <span class="text-sm text-gray-600">Sync repositories and commit history</span>
                </div>
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-sm text-gray-600">Analyze programming language usage</span>
                </div>
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-sm text-gray-600">Auto-create skills from detected languages</span>
                </div>
            </div>
            <button @onclick="ConnectGitHub" class="btn-primary inline-flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                Connect with GitHub
            </button>
        </div>
    }
</div>

@code {
    private GitHubConnection? connection;
    private GitHubStats? stats;
    private bool isLoading = true;
    private bool isSyncing = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    
        // Listen for GitHub callback
        await JSRuntime.InvokeVoidAsync("eval", @"
            window.addEventListener('message', async function(event) {
                if (event.data.type === 'github-callback') {
                    DotNet.invokeMethodAsync('SkillSync.Web', 'HandleGitHubCallback', event.data.code);
                }
            });
        ");
    }

    private async Task LoadData()
    {
        isLoading = true;
        connection = await GitHubService.GetConnectionStatusAsync();
    
        if (connection?.IsConnected == true)
        {
            stats = await GitHubService.GetStatsAsync();
        }
    
        isLoading = false;
    }

    private async Task ConnectGitHub()
    {
        var authUrl = await GitHubService.GetAuthUrlAsync();
        if (!string.IsNullOrEmpty(authUrl))
        {
            await JSRuntime.InvokeVoidAsync("open", authUrl, "_blank", "width=600,height=700");
        }
    }

    [JSInvokable]
    public static async Task HandleGitHubCallback(string code)
    {
        // This would be called from JavaScript
        // In a real implementation, you'd need to get the service instance
    }

    private async Task Disconnect()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to disconnect GitHub?");
        if (confirmed)
        {
            await GitHubService.DisconnectAsync();
            await LoadData();
        }
    }

    private async Task SyncData()
    {
        isSyncing = true;
        await GitHubService.SyncAsync();
        await LoadData();
        isSyncing = false;
    }
}